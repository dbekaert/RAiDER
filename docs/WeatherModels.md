# Accessing weather model data
RAiDER has built-in support for a number of different weather models.  RAiDER provides all the interfacing to data servers required to access data for the different weather models, although some weather models require a license agreement and account setup. Instructions for accessing data, including license-limited data, are provided below. It is the user's responsibility to accept license agreements for whatever model is desired. 

In addition, RAiDER provides functionality for adding additional weather models. See the [RAiDER-docs repository](https://github.com/dbekaert/RAiDER-docs) page on how to do this. We would love to expand the suite of supported models, and welcome any contributions. Please see the contributing guidelines or reach out through an issue ticket for help. 

------

## 1. Usage

::: RAiDER.processWM.prepareWeatherModel
    options:
      show_root_heading: true
      heading_level: 3

### Potential download failure
ERA-5/ERA-I datasets require access to the ESA Copernicus servers. GMAO and MERRA-2 datasets require access to the NASA Earthdata servers. If you are unable to download datasets, ensure that you have registered an account, configured your public API key on your computer, and accepted/added the license/application for type of dataset you wish to download as detailed below. 

------

## 2. NOAA weather models (HRRR)
High-resolution rapid refresh (HRRR) weather model data datasets are generated by __[NOAA](https://rapidrefresh.noaa.gov/hrrr/)__ for the coninental US (CONUS) but not archived beyond three days. However, a public __[archive](https://home.chpc.utah.edu/~u0553130/Brian_Blaylock/hrrr_FAQ.html)__ is available from the University of Utah. This archive does not require a license agreement. This model has the highest spatial resolution available in RAiDER, with a horizontal grid spacing of about 3 km, and is provided in a Lambert conformal conic projection. 

------

## 3. ECMWF weather models (ERA5, ERA5T, ERAI, HRES)
The European Centre for Medium-Range Weather Forecasts (__[ECMWF](https://www.ecmwf.int/)__), through the Copernicus Climate Data Store (CDS), provides a number of different weather models, including ERA5 and ERA5T reanalysis models.  

You can read more information about their reanalysis models __[here](https://www.ecmwf.int/en/research/climate-reanalysis)__ and real-time model __[here](https://www.ecmwf.int/en/forecasts/datasets/catalogue-ecmwf-real-time-products)__. ECMWF models are global, with horizontal resolution of about 30 km for ERA-I, ERA-5, and ERA-5T, and 6 km for Hi-RES. All of these models come in a global projection (EPSG 4326, WGS-84). 

### Accessing ERA5 and ERA5T weather reanalysis datasets from Copernicus CDS
1. Create an ECMWF account at __[ecmwf.int](https://www.ecmwf.int/)__. 
2. Confirm your email, etc. 
3. Set up your CDS API personal access token __[here](https://cds.climate.copernicus.eu/how-to-api)__. Only Step 1 on the page is necessary.
4. **Optional:** Install the CDS API using pip:

        pip install cdsapi

    **Note**: this step has been included in the conda installation of RAiDER, but you can do this if you want to be able to use the CDS API outside of your RAiDER environment.

5. Accept the __[ECMWF license agreement](https://apps.ecmwf.int/datasets/licences/copernicus/)__.

> [!IMPORTANT]
> In late 2024, the CDS API underwent a migration that invalidated all existing personal access tokens. Current RAiDER users will have to follow the above instructions again to continue being able to the ECMWF weather models.


### Accessing ERAI, HRES

ECMWF requires a license agreement to be able to access, download, and use their datasets. Instructions for completing this process is below. 

1. Create an ECMWF account at __[ecmwf.int](https://www.ecmwf.int/)__.  The ERA-I model is open-access, while HRES requires a special licence agreement.
2. Confirm your email, etc. 
3. Install the public API key and client as instructed __[here](https://confluence.ecmwf.int/display/WEBAPI/Access+ECMWF+Public+Datasets#AccessECMWFPublicDatasets-key)__: 
    
    a. Copy the URL and API key from the webpage into a file in your home directory name `~/.ecmwfapirc`

        {
            "url"   : "https://api.ecmwf.int/v1",
            "key"   : your key here,
            "email" : your email here
        }

    **Note**: the email that is used to register the user account, and the key represents the API key obtained upon the registration of ECMWF API, and should be replaced with the user's own information.

    b. **Optional:** Install the ECMWF API using pip:

        pip install ecmwf-api-client

    **Note**: this step has been included in the conda installation of RAiDER, but you can do this if you want to be able to use the CDS API outside of your RAiDER environment.

## 4. NASA weather models (GMAO, MERRA2)
    
1. The Global Modeling and Assimilation Office (__[GMAO](https://www.nccs.nasa.gov/services/data-collections/coupled-products/geos5-forecast#:~:text=The%20Global%20Modeling%20and%20Assimilation,near%2Dreal%2Dtime%20production.)__) at NASA generates reanalysis weather models. GMAO datasets can also be accessed without a license agreement through the pyDAP interface implemented in RAiDER. GMAO has a horizontal grid spacing of approximately 33 km, and its projection is EPSG code 4326 (WGS-84). 

2. The Modern-Era Retrospective analysis for Research and Applications, Version 2 (__[MERRA-2](https://gmao.gsfc.nasa.gov/reanalysis/MERRA-2/#:~:text=MERRA%2D2%20is%20the%20first,(say)%20Greenland%20and%20Antarctica.)__) provides data beginning in 1980. MERRA-2 is also produced by NASA and has a spatial resolution of about 50 km and a global projection (EPSG 4326, WGS-84).  

Reference: __[The Modern-Era Retrospective Analysis for Research and Applications, Version 2 (MERRA-2)](https://journals.ametsoc.org/view/journals/clim/30/14/jcli-d-16-0758.1.xml)__, Ronald Gelaro, et al., 2017, J. Clim., doi: 10.1175/JCLI-D-16-0758.1

### Accessing NASA weather model data
1. Create an account on the NASA's Earthdata website [here](https://urs.earthdata.nasa.gov)
2. Confirm your email, etc. 
3. Copy the login username and password to a file in your home directory name ~/.netrc 
         
         machine urs.earthdata.nasa.gov
                 login <USERNAME>
                 password <PASSWORD>
                 
    **Note**: the username and password represent the user's username and password.
   
4. Add the application `NASA GESDISC DATA ARCHIVE` by clicking on the `Applications->Authorized Apps` on the menu after logging into your Earthdata profile, and then scrolling down to the application `NASA GESDISC DATA ARCHIVE` to approve it. _This seems not required for GMAO for now, but recommended to do so for all OpenDAP-based weather models._
5. Install the OpenDAP using pip: 

         pip install pydap==3.2.1
      

    **Note**: this step has been included in the conda install of RAiDER, thus can be omitted if one uses the recommended conda install of RAiDER
   
    **Note**: PyDAP v3.2.1 is required for now (thus specified in the above pip install command) because the latest v3.2.2 (as of now) has a known [bug](https://colab.research.google.com/drive/1f_ss1Oa3VzgAOd_p8sgekdnLVE5NW6s5) in accessing and slicing the GMAO data. This bug is expected to be fixed in newer versions of PyDAP.
